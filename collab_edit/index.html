<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CollabEdit</title>
  <script src="scripts/diff_match_patch_uncompressed.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
</head>
<body>
  <textarea name="Text1"  id = "1" cols="40" rows="5"></textarea>
  <script>
  	var diffObj = new diff_match_patch();
  	var text1Shadow = "";

    var socket = new WebSocket('ws://localhost:8888');

    socket.onmessage = function (evnt){
      msg = JSON.parse(event.data);
      switch (msg.type){
        case 1:
          to_send = {
            type : 2,
            data { get_diff() }
          }
          socket.send(JSON.stringify(to_send));
        case 3:
          apply_diff(msg.data)
          ack = {
            type : 4,
            data {}
          }
          socket.send(ack);
      }
    }

    function get_diff(){
      var text1 = $("#1").val();
      diff =  diffObj.diff_main(text1Shadow, text1);
      // Save the current text to diff agaisnt in future.
      text1Shadow = text1;
      return diff;
    }


    function apply_diff(diff){
      // Generate the patches.
      var patch1 = diffObj.patch_make(text1Shadow, diff);
      var patch2 = diffObj.patch_make(text1, diff);

      // Patch the shadow then the main text.
      text1Shadow = diffObj.patch_apply(patch1, text1Shadow)[0];
      $("#1").val(diffObj.patch_apply(patch2, $("#1").val())[0]);
    }
  </script>
</body>
</html>